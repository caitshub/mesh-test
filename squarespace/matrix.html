<!-- HML VER 4 for GLOBALLY NORMALISED -->

<!-- Main container for the entire component -->
<div class="matrix-component">
    <!-- The entire layout is controlled by a single CSS Grid on this container -->
    <h1 class="matrix-title-main">globally normalised [%]</h1>
    <h2 class="matrix-title-postsynaptic">postsynaptic cell type</h2>
    <div class="matrix-title-presynaptic"><span>presynaptic cell type</span></div>

    <div class="matrix-grid-container">
        <div class="matrix-grid">
            <!-- Column Headers with data-col attributes -->
            <div class="grid-cell empty"></div>
            <div class="grid-cell col-label" data-col="msn"><span>MSN</span></div>
            <div class="grid-cell col-label" data-col="stn"><span>STN</span></div>
            <div class="grid-cell col-label" data-col="tan"><span>TAN</span></div>
            <div class="grid-cell col-label" data-col="gpe"><span>GPe</span></div>
            <div class="grid-cell col-label" data-col="gpi"><span>GPi</span></div>
            <div class="grid-cell col-label" data-col="lts"><span>LTS</span></div>
            <div class="grid-cell col-label" data-col="int1"><span>INT1</span></div>
            <div class="grid-cell col-label" data-col="int2"><span>INT2</span></div>
            <div class="grid-cell col-label" data-col="int3"><span>INT3</span></div>

            <!-- Row 1: DA -->
            <div class="grid-cell row-label" data-row="da">DA</div>
            <div class="grid-cell data-cell" data-row="da" data-col="msn" data-target="cell-DA-MSN" style="background-color: hsl(0, 0%, 96.6%);">1.8</div>
            <div class="grid-cell data-cell" data-row="da" data-col="stn" data-target="cell-DA-STN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="tan" data-target="cell-DA-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="gpe" data-target="cell-DA-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="gpi" data-target="cell-DA-GPi" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="lts" data-target="cell-DA-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="int1" data-target="cell-DA-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="int2" data-target="cell-DA-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="da" data-col="int3" data-target="cell-DA-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 2: LMAN -->
            <div class="grid-cell row-label" data-row="lman">LMAN</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="msn" data-target="cell-LMAN-MSN" style="background-color: hsl(0, 0%, 77.1%);">12.1</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="stn" data-target="cell-LMAN-STN" style="background-color: hsl(0, 0%, 99.2%);">0.4</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="tan" data-target="cell-LMAN-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="gpe" data-target="cell-LMAN-GPe" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="gpi" data-target="cell-LMAN-GPi" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="lts" data-target="cell-LMAN-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="int1" data-target="cell-LMAN-INT1" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="int2" data-target="cell-LMAN-INT2" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="lman" data-col="int3" data-target="cell-LMAN-INT3" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>

            <!-- Row 3: HVC -->
            <div class="grid-cell row-label" data-row="hvc">HVC</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="msn" data-target="cell-HVC-MSN" style="background-color: hsl(0, 0%, 0.0%); color: white;">52.9</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="stn" data-target="cell-HVC-STN" style="background-color: hsl(0, 0%, 99.1%);">0.5</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="tan" data-target="cell-HVC-TAN" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="gpe" data-target="cell-HVC-GPe" style="background-color: hsl(0, 0%, 98.1%);">1.0</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="gpi" data-target="cell-HVC-GPi" style="background-color: hsl(0, 0%, 96.2%);">2.0</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="lts" data-target="cell-HVC-LTS" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="int1" data-target="cell-HVC-INT1" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="int2" data-target="cell-HVC-INT2" style="background-color: hsl(0, 0%, 99.1%);">0.5</div>
            <div class="grid-cell data-cell" data-row="hvc" data-col="int3" data-target="cell-HVC-INT3" style="background-color: hsl(0, 0%, 96.0%);">2.1</div>

            <!-- Row 4: MSN -->
            <div class="grid-cell row-label" data-row="msn">MSN</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="msn" data-target="cell-MSN-MSN" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="stn" data-target="cell-MSN-STN" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="tan" data-target="cell-MSN-TAN" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="gpe" data-target="cell-MSN-GPe" style="background-color: hsl(0, 0%, 97.0%);">1.6</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="gpi" data-target="cell-MSN-GPi" style="background-color: hsl(0, 0%, 91.1%);">4.7</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="lts" data-target="cell-MSN-LTS" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="int1" data-target="cell-MSN-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="int2" data-target="cell-MSN-INT2" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="msn" data-col="int3" data-target="cell-MSN-INT3" style="background-color: hsl(0, 0%, 99.2%);">0.4</div>

            <!-- Row 5: STN -->
            <div class="grid-cell row-label" data-row="stn">STN</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="msn" data-target="cell-STN-MSN" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="stn" data-target="cell-STN-STN" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="tan" data-target="cell-STN-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="gpe" data-target="cell-STN-GPe" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="gpi" data-target="cell-STN-GPi" style="background-color: hsl(0, 0%, 98.3%);">0.9</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="lts" data-target="cell-STN-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="int1" data-target="cell-STN-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="int2" data-target="cell-STN-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="stn" data-col="int3" data-target="cell-STN-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 6: TAN -->
            <div class="grid-cell row-label" data-row="tan">TAN</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="msn" data-target="cell-TAN-MSN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="stn" data-target="cell-TAN-STN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="tan" data-target="cell-TAN-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="gpe" data-target="cell-TAN-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="gpi" data-target="cell-TAN-GPi" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="lts" data-target="cell-TAN-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="int1" data-target="cell-TAN-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="int2" data-target="cell-TAN-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="tan" data-col="int3" data-target="cell-TAN-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 7: GPe -->
            <div class="grid-cell row-label" data-row="gpe">GPe</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="msn" data-target="cell-GPe-MSN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="stn" data-target="cell-GPe-STN" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="tan" data-target="cell-GPe-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="gpe" data-target="cell-GPe-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="gpi" data-target="cell-GPe-GPi" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="lts" data-target="cell-GPe-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="int1" data-target="cell-GPe-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="int2" data-target="cell-GPe-INT2" style="background-color: hsl(0, 0%, 99.2%);">0.4</div>
            <div class="grid-cell data-cell" data-row="gpe" data-col="int3" data-target="cell-GPe-INT3" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>

            <!-- Row 8: GPi -->
            <div class="grid-cell row-label" data-row="gpi">GPi</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="msn" data-target="cell-GPi-MSN" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="stn" data-target="cell-GPi-STN" style="background-color: hsl(0, 0%, 98.5%);">0.8</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="tan" data-target="cell-GPi-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="gpe" data-target="cell-GPi-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="gpi" data-target="cell-GPi-GPi" style="background-color: hsl(0, 0%, 98.7%);">0.7</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="lts" data-target="cell-GPi-LTS" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="int1" data-target="cell-GPi-INT1" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="int2" data-target="cell-GPi-INT2" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
            <div class="grid-cell data-cell" data-row="gpi" data-col="int3" data-target="cell-GPi-INT3" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>

            <!-- Row 9: LTS -->
            <div class="grid-cell row-label" data-row="lts">LTS</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="msn" data-target="cell-LTS-MSN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="stn" data-target="cell-LTS-STN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="tan" data-target="cell-LTS-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="gpe" data-target="cell-LTS-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="gpi" data-target="cell-LTS-GPi" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="lts" data-target="cell-LTS-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="int1" data-target="cell-LTS-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="int2" data-target="cell-LTS-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="lts" data-col="int3" data-target="cell-LTS-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 10: INT1 -->
            <div class="grid-cell row-label" data-row="int1">INT1</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="msn" data-target="cell-INT1-MSN" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="stn" data-target="cell-INT1-STN" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="tan" data-target="cell-INT1-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="gpe" data-target="cell-INT1-GPe" style="background-color: hsl(0, 0%, 98.9%);">0.6</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="gpi" data-target="cell-INT1-GPi" style="background-color: hsl(0, 0%, 98.5%);">0.8</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="lts" data-target="cell-INT1-LTS" style="background-color: hsl(0, 0%, 99.8%);">0.1</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="int1" data-target="cell-INT1-INT1" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="int2" data-target="cell-INT1-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int1" data-col="int3" data-target="cell-INT1-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 11: INT2 -->
            <div class="grid-cell row-label" data-row="int2">INT2</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="msn" data-target="cell-INT2-MSN" style="background-color: hsl(0, 0%, 95.3%);">2.5</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="stn" data-target="cell-INT2-STN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="tan" data-target="cell-INT2-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="gpe" data-target="cell-INT2-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="gpi" data-target="cell-INT2-GPi" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="lts" data-target="cell-INT2-LTS" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="int1" data-target="cell-INT2-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="int2" data-target="cell-INT2-INT2" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int2" data-col="int3" data-target="cell-INT2-INT3" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>

            <!-- Row 12: INT3 -->
            <div class="grid-cell row-label" data-row="int3">INT3</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="msn" data-target="cell-INT3-MSN" style="background-color: hsl(0, 0%, 86.0%);">7.4</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="stn" data-target="cell-INT3-STN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="tan" data-target="cell-INT3-TAN" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="gpe" data-target="cell-INT3-GPe" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="gpi" data-target="cell-INT3-GPi" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="lts" data-target="cell-INT3-LTS" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="int1" data-target="cell-INT3-INT1" style="background-color: hsl(0, 0%, 100.0%);">0.0</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="int2" data-target="cell-INT3-INT2" style="background-color: hsl(0, 0%, 99.6%);">0.2</div>
            <div class="grid-cell data-cell" data-row="int3" data-col="int3" data-target="cell-INT3-INT3" style="background-color: hsl(0, 0%, 99.4%);">0.3</div>
        </div>
    </div>
    
    <div class="gradient-bar-container">
        <div class="gradient-bar"></div>
        <div class="gradient-labels">
            <span>50</span><span>40</span><span>30</span><span>20</span><span>10</span><span>0</span>
        </div>
    </div>
</div>


<style>
  /* --- BASE LAYOUT & RESPONSIVE ENGINE --- */
  .matrix-component {
    font-family: Arial, sans-serif;
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
    padding: 1em;
    box-sizing: border-box;
    display: grid;
    grid-template-areas:
      "title-main title-main title-main"
      ". title-post ."
      "title-pre grid gradient";
    grid-template-columns: auto 1fr auto;
    grid-template-rows: auto auto 1fr;
    gap: 0 15px;
    align-items: center;
  }

  .matrix-title-main { grid-area: title-main; text-align: center; font-weight: bold; font-size: 2em; margin-bottom: 0.5em; }
  .matrix-title-postsynaptic { grid-area: title-post; text-align: center; font-weight: bold; font-size: 1.2em; margin-bottom: 0.5em; color: #333; }
  .matrix-title-presynaptic { grid-area: title-pre; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; }
  .matrix-title-presynaptic span { writing-mode: vertical-rl; transform: rotate(180deg); font-size: 1.2em; }
  .matrix-grid-container { grid-area: grid; }
  
  .gradient-bar-container { 
    grid-area: gradient; 
    display: flex; 
    flex-direction: row; 
    align-self: stretch; /* This is the crucial fix for the desktop gradient bar */
  }

  /* --- DATA GRID STYLES --- */
  .matrix-grid { 
    display: grid; 
    grid-template-columns: minmax(50px, 0.7fr) repeat(9, minmax(50px, 1fr)); 
    gap: 0; 
    border: 1px solid #ccc; 
    border-width: 0 1px 1px 0; 
  }
  
  .grid-cell { 
    background-color: #fff; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: clamp(0.7rem, 1.5vw, 1rem); 
    border: 1px solid #ccc; 
    border-width: 1px 0 0 1px; 
    aspect-ratio: 1.5 / 1; 
  }
  
  .grid-cell.row-label {
    font-weight: bold;
    aspect-ratio: auto; 
  }
  
  .grid-cell.col-label { font-weight: bold; }
  .grid-cell.col-label span { transform: rotate(-45deg); }
  .grid-cell.empty { background-color: transparent; border-color: transparent; }
  .data-cell { cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; position: relative; z-index: 1; }
  .data-cell:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 2; }
  .grid-cell.highlight { background-color: #e0f3ff; }

  /* --- GRADIENT BAR (Desktop) --- */
  .gradient-bar { 
    width: 25px; 
    height: 100%; 
    background: linear-gradient(to top, #ffffff, #808080, #000000); 
  }
  .gradient-labels { 
    display: flex; 
    flex-direction: column; 
    justify-content: space-between; 
    margin-left: 5px; 
    height: 100%;
    font-size: clamp(0.6rem, 1vw, 0.8rem); 
  }

  /* --- RESPONSIVE STYLES FOR MOBILE --- */
  @media (max-width: 768px) {
    .matrix-component {
      grid-template-areas:
        "title-main"
        "title-post"
        "grid"
        "gradient";
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto auto;
      gap: 1em 0;
    }

    .matrix-title-presynaptic { display: none; }
    .matrix-grid-container { overflow-x: hidden; }
    
    .matrix-grid {
      grid-template-columns: 0.8fr repeat(9, 1fr); 
    }

    .grid-cell {
      font-size: clamp(0.5rem, 2.5vw, 0.7rem);
      min-width: 0;
      aspect-ratio: 1.2 / 1;
    }
    
    .grid-cell.col-label span { transform: rotate(-65deg); }

    .gradient-bar-container {
      grid-area: gradient;
      display: flex;
      flex-direction: column;
      width: 100%;
      padding: 0 5%;
      box-sizing: border-box;
      align-self: auto; /* Reset self-alignment for mobile */
    }

    .gradient-bar {
      width: 100%;
      height: 20px;
      background: linear-gradient(to left, #ffffff, #808080, #000000);
    }

    .gradient-labels {
      flex-direction: row;
      justify-content: space-between;
      width: 100%;
      height: auto;
      margin-left: 0;
      margin-top: 5px;
      font-size: 0.7rem;
    }
  }
</style>
<script>
    // This function sets up all the lightbox's internal parts and returns
    // the function that can be used to open it.
    function setupLightbox() {
        const lightboxModal = document.querySelector('.new-lightbox');
        if (!lightboxModal || lightboxModal.dataset.lightboxInitialized) {
            // If the lightbox doesn't exist or is already set up, stop.
            // If it's already set up, just return the existing open function.
            return window.openLightboxFunction || null;
        }
        lightboxModal.dataset.lightboxInitialized = 'true';

        // Find all the lightbox elements
        const closeButton = lightboxModal.querySelector('.new-close-button');
        const img1 = lightboxModal.querySelector('#lightbox-img-1');
        const img2 = lightboxModal.querySelector('#lightbox-img-2');
        const img3 = lightboxModal.querySelector('#lightbox-img-3');
        const img4 = lightboxModal.querySelector('#lightbox-img-4');
        const captionTopEl = lightboxModal.querySelector('.caption-top');
        const captionBottomLeftEl = lightboxModal.querySelector('.caption-bottom-left');
        const captionBottomMiddleEl = lightboxModal.querySelector('.caption-bottom-middle');
        const captionBottomRightEl = lightboxModal.querySelector('.caption-bottom-right');

        // Data for each lightbox popup
        const lightboxData = {
            'cell-HVC-MSN': {img1: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/be7d2191-78e3-47d5-8587-7ec8da2d88e0/250825_hvc_full_100%C2%B5m_v2.png?content-type=image%2Fpng',
                    img2: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/23faabb8-2701-4a0d-a256-f989c23def3e/250825_hvc_msn_syn_1%C2%B5m.png?content-type=image%2Fpng',
                    img3: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/7b99fc6b-3bae-4d94-9928-7996f615a250/250825_XY_9920_5976_10514_hvc_msn_syn.png?content-type=image%2Fpng',
                    img4: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/161707bf-9eeb-4307-a86d-ba9faf073959/250825_msn_full_100%C2%B5m.png?content-type=image%2Fpng',
                    captionTop: 'HVC -> MSN: Detailed Synaptic Connection',
                    captionBottomLeft: 'Presynaptic Neuron',
                    captionBottomMiddle: 'This connection is vital for motor sequence learning. The images show morphological details from different microscopy techniques.',
                    captionBottomRight: 'Postsynaptic Dendrite' },
            'cell-LMAN-MSN': {img1: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/114dc0d6-be6e-48b6-8ae4-59c438c63b70/231121_stn_gpi_100%C2%B5m.png?content-type=image%2Fpng',
                    img2: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/114dc0d6-be6e-48b6-8ae4-59c438c63b70/231121_stn_gpi_100%C2%B5m.png?content-type=image%2Fpng',
                    img3: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/114dc0d6-be6e-48b6-8ae4-59c438c63b70/231121_stn_gpi_100%C2%B5m.png?content-type=image%2Fpng',
                    img4: 'https://images.squarespace-cdn.com/content/6877b03b11b9de015acd8b39/114dc0d6-be6e-48b6-8ae4-59c438c63b70/231121_stn_gpi_100%C2%B5m.png?content-type=image%2Fpng',
                    captionTop: 'LMAN -> MSN Connection',
                    captionBottomMiddle: 'Information specific to the LMAN to MSN pathway.'},
            // Add all other cell data here
        };

        // This is the function that will be called to open the lightbox
        const openLightbox = function(target) {
            const data = lightboxData[target];
            if (data) {
                if (img1) img1.src = data.img1 || '';
                if (img2) img2.src = data.img2 || '';
                if (img3) img3.src = data.img3 || '';
                if (img4) img4.src = data.img4 || '';
                const captions = [
                    [captionTopEl, data.captionTop],
                    [captionBottomLeftEl, data.captionBottomLeft],
                    [captionBottomMiddleEl, data.captionBottomMiddle],
                    [captionBottomRightEl, data.captionBottomRight]
                ];
                captions.forEach(([element, text]) => {
                    if (element) {
                        element.style.display = text ? 'flex' : 'none';
                        element.textContent = text || '';
                    }
                });
                lightboxModal.classList.add('lightbox-visible');
            }
        };

        const closeLightbox = () => lightboxModal.classList.remove('lightbox-visible');

        // Attach closing event listeners
        if (closeButton) closeButton.addEventListener('click', closeLightbox);
        lightboxModal.addEventListener('click', (e) => {
            if (e.target === lightboxModal) closeLightbox();
        });
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        // Store the open function on the window object so it can be retrieved later
        window.openLightboxFunction = openLightbox;
        
        // ** THE KEY CHANGE: **
        // Return the 'openLightbox' function so other parts of the script can use it.
        return openLightbox;
    }

    // This function now ACCEPTS the 'openLightbox' function as an argument.
    function setupGrid(openLightboxFunction) {
        if (!openLightboxFunction) return; // Don't run if the lightbox isn't ready

        document.querySelectorAll('.matrix-component:not([data-grid-initialized])').forEach(matrix => {
            matrix.dataset.gridInitialized = 'true';
            const allLabels = matrix.querySelectorAll('.row-label, .col-label');

            matrix.querySelectorAll('.data-cell').forEach(cell => {
                // Hover effects
                cell.addEventListener('mouseover', function() { /* ... hover code ... */ });
                cell.addEventListener('mouseout', () => { /* ... hover code ... */ });

                // Attach the click listener
                cell.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    // Use the function that was passed in!
                    openLightboxFunction(target);
                });
            });
        });
    }

    // The main function that coordinates everything
    function initializeAll() {
        // First, set up the lightbox and get the function to open it.
        const openFunc = setupLightbox();
        // Then, pass that function into the grid setup.
        if (openFunc) {
            setupGrid(openFunc);
        }
    }

    // Robust loaders for Squarespace
    document.addEventListener('DOMContentLoaded', initializeAll);
    window.setInterval(initializeAll, 500);
</script>
